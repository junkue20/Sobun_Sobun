<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mapper.km.KmCustomerMapper">

<!-- 물품 상세 조회 페이지 -->

    <!-- 상품 정보 한개 가져오기 -->
    <select id="selectOneItem" parameterType="long" resultType="map">
        SELECT * FROM kmitemview k WHERE itemno=#{itemno}
    </select>

    <!-- 상품 번호에 해당하는 이미지 번호 가져오기 -->
    <select id="selectItemImageNoList" parameterType="long" resultType="long">
        SELECT no FROM ITEMIMAGE i WHERE ITEMNO = #{itemno}   
    </select>

    <!-- 상품에 대한 열린 공구 가져오기 -> 남은 인원 -->
    <select id="countRemainingPerson" parameterType="long" resultType="int">
       SELECT  participant-count(*) 
        FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY memid ORDER BY no desc) recent 
 		FROM kmpurchaseview p WHERE purchaseno = #{purchaseNo}) 
        WHERE recent=1 AND state=0 AND cancel=0
    </select>

    <!-- 상품에 대한 열린 공구 가져오기 -> 공구번호, 참여인원, 마감기한, 보관소 코드, 보관소이름 -->
    <select id="selectPurchaseList" parameterType="long" resultType="KmPurchaseView">
        SELECT * FROM (
				SELECT * FROM (SELECT *, ROW_NUMBER() OVER 
				(PARTITION BY PURCHASENO ORDER BY no desc) recent 
									FROM KMPURCHASEVIEW p WHERE itemno = #{itemno}
									ORDER BY PURCHASENO DESC 
				  ) WHERE recent=1 AND deadline > CURRENT_TIMESTAMP()  ORDER BY deadline DESC
		)
    </select>

    <!-- 모든 보관소 정보 가져오기 -->
    <select id="selectStorageList" resultType="Storage">
        SELECT * FROM storage ORDER BY NAME ASC
    </select>

    <!-- 공구 번호에 대한 공구 정보 가져오기 -->
    <select id="selectOnePurchase" parameterType="long" resultType="kmPurchaseView">
        SELECT * FROM (
				SELECT * FROM (SELECT *, ROW_NUMBER() OVER 
				(PARTITION BY PURCHASENO ORDER BY no desc) recent 
									FROM KMPURCHASEVIEW p WHERE purchaseNo=#{purchaseNo}
									ORDER BY PURCHASENO DESC 
				) WHERE recent=1
    )
    </select>

    <!-- 보관소 번호에 해당하는 보관소 정보 가져오기 -->
    <select id="selectOneStorage" parameterType="long" resultType="Storage">
        SELECT * FROM storage WHERE NO=#{no}
    </select>

    <!-- 고객 정보 가져오기 -->
    <select id="selectOneCustomer" parameterType="string" resultType="Customer">
        SELECT id, name, phone, email FROM CUSTOMER c WHERE id=#{id}
    </select>
</mapper>